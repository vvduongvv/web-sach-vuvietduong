<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading - BookVoyage</title>
    <link rel="icon" type="image/png" href="/images/logo.png">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://covers.openlibrary.org">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://covers.openlibrary.org">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"></noscript>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Lora:ital,wght@0,400;0,600;1,400&family=Source+Serif+4:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
    /* ===== PROFESSIONAL READER — Inspired by Wattpad, Kindle, Medium ===== */
    * { box-sizing: border-box; }

    /* Reduce header bottom margin in reader */
    .header { margin-bottom: 0; }

    /* Progress bar */
    .reading-progress-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 0%;
        height: 3px;
        background: linear-gradient(90deg, #e94560, #f89820);
        z-index: 10001;
        transition: width 0.08s linear;
    }

    /* Reader top bar */
    .reader-topbar {
        position: sticky;
        top: 64px;
        z-index: 999;
        background: rgba(255,255,255,0.98);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border-bottom: 1px solid rgba(0,0,0,0.06);
        padding: 0 24px;
        height: 54px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: box-shadow 0.3s;
    }
    .reader-topbar.shadow { box-shadow: 0 2px 24px rgba(0,0,0,0.06); }
    .topbar-left {
        display: flex;
        align-items: center;
        gap: 14px;
        min-width: 0;
        flex: 1;
    }
    .topbar-left .mini-title {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        opacity: 1;
        transform: none;
        transition: all 0.3s;
    }
    .topbar-left .mini-title.visible { opacity: 1; transform: translateY(0); }

    .topbar-right {
        display: flex;
        align-items: center;
        gap: 2px;
        flex-shrink: 0;
    }
    .topbar-btn {
        width: 38px; height: 38px;
        border-radius: 10px;
        border: none;
        background: transparent;
        color: #666;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 15px;
        transition: all 0.2s;
    }
    .topbar-btn:hover { background: #f0f0f0; color: #e94560; }
    .topbar-btn.active { color: #e94560; background: rgba(233,69,96,0.08); }
    .topbar-progress {
        font-size: 12px;
        color: #bbb;
        font-weight: 600;
        min-width: 38px;
        text-align: center;
        font-variant-numeric: tabular-nums;
    }

    /* Breadcrumb */
    .reader-breadcrumb {
        padding: 12px 24px;
        font-size: 13px;
        color: #888;
        text-align: center;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        background: rgba(0,0,0,0.01);
    }
    .reader-breadcrumb a {
        color: #666;
        text-decoration: none;
        transition: color 0.15s;
    }
    .reader-breadcrumb a:hover { color: #c0392b; text-decoration: underline; }
    .reader-breadcrumb .bc-sep {
        margin: 0 6px;
        color: #ccc;
    }
    .reader-breadcrumb .bc-current {
        color: #999;
    }

    /* Title section — truyenfull style */
    .reader-title-section {
        padding: 32px 24px 8px;
        text-align: center;
        background: transparent;
    }
    .reader-title-section .book-title {
        font-size: 26px;
        font-weight: 700;
        color: #c0392b;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        line-height: 1.4;
        margin-bottom: 10px;
        font-family: 'Merriweather', Georgia, serif;
    }
    .reader-title-section .book-author {
        font-size: 15px;
        color: #888;
        margin-bottom: 4px;
        font-weight: 400;
    }
    .reader-title-section .book-author a {
        color: #8b7355;
        text-decoration: none;
    }
    .reader-title-section .book-author a:hover { text-decoration: underline; }
    .reader-title-section .page-info {
        font-size: 14px;
        color: #999;
        margin: 4px 0 0;
    }

    /* Ornamental dividers */
    .ornament-divider {
        text-align: center;
        padding: 10px 0;
        user-select: none;
        line-height: 1;
    }
    .ornament-divider svg {
        width: 120px;
        height: auto;
        opacity: 0.5;
    }
    .ornament-large {
        padding: 16px 0;
    }
    .ornament-large svg {
        width: 200px;
        opacity: 0.45;
    }

    /* Chapter navigation bar */
    .chapter-nav {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 10px 24px;
    }
    .chapter-nav .nav-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 28px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        color: #fff;
        font-family: inherit;
        white-space: nowrap;
        text-shadow: 0 1px 1px rgba(0,0,0,0.1);
    }
    .chapter-nav .nav-btn-prev {
        background: linear-gradient(180deg, #b5b5b5, #9a9a9a);
        box-shadow: 0 2px 4px rgba(0,0,0,0.12);
    }
    .chapter-nav .nav-btn-prev:not(:disabled):hover {
        background: linear-gradient(180deg, #a0a0a0, #888);
        box-shadow: 0 3px 6px rgba(0,0,0,0.18);
    }
    .chapter-nav .nav-btn-list {
        background: linear-gradient(180deg, #7a7a7a, #666);
        box-shadow: 0 2px 4px rgba(0,0,0,0.12);
        padding: 12px 18px;
        font-size: 16px;
    }
    .chapter-nav .nav-btn-list:hover {
        background: linear-gradient(180deg, #666, #555);
        box-shadow: 0 3px 6px rgba(0,0,0,0.18);
    }
    .chapter-nav .nav-btn-next {
        background: linear-gradient(180deg, #5cb85c, #449d44);
        box-shadow: 0 2px 4px rgba(0,0,0,0.12);
    }
    .chapter-nav .nav-btn-next:not(:disabled):hover {
        background: linear-gradient(180deg, #4cae4c, #398439);
        box-shadow: 0 3px 6px rgba(0,0,0,0.18);
    }
    .chapter-nav .nav-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        box-shadow: none;
    }

    /* Main content wrapper */
    .reader-content-wrapper {
        max-width: 720px;
        margin: 0 auto;
        padding: 48px 24px 80px;
        min-height: 60vh;
    }
    .reader-content-wrapper.wide { max-width: 960px; }

    /* Reading area — the core */
    #reading-area {
        font-family: 'Merriweather', Georgia, 'Times New Roman', serif;
        font-size: 18px;
        line-height: 1.9;
        color: #2c2c2c;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    #reading-area p {
        margin-bottom: 1.5em;
        text-align: justify;
        hyphens: auto;
        -webkit-hyphens: auto;
    }
    #reading-area .section-heading {
        font-size: 1.4em;
        font-weight: 700;
        color: #1a1a2e;
        margin: 2.5em 0 1em;
        padding-bottom: 12px;
        border-bottom: 2px solid #e94560;
        font-family: 'Segoe UI', system-ui, sans-serif;
        letter-spacing: -0.3px;
        line-height: 1.3;
    }
    #reading-area .section-heading:first-child {
        margin-top: 0;
    }
    #reading-area .sub-heading {
        font-size: 1.15em;
        font-weight: 600;
        color: #0f3460;
        margin: 2em 0 0.6em;
        font-family: inherit;
        line-height: 1.4;
    }
    #reading-area blockquote {
        border-left: 3px solid #e94560;
        padding: 16px 24px;
        margin: 2em 0;
        background: rgba(233,69,96,0.03);
        border-radius: 0 12px 12px 0;
        font-style: italic;
        color: #555;
        line-height: 1.8;
    }
    #reading-area .list-item {
        padding-left: 1.8em;
        text-indent: -1.8em;
        margin-bottom: 0.8em;
    }
    #reading-area .separator {
        text-align: center;
        margin: 3em 0;
        color: #ddd;
        font-size: 20px;
        letter-spacing: 12px;
    }

    /* Skeleton loading */
    .skeleton-reading { padding: 10px 0; }
    .sk-line {
        height: 16px;
        background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%);
        background-size: 400% 100%;
        animation: skPulse 1.5s ease infinite;
        border-radius: 8px;
        margin-bottom: 16px;
    }
    .sk-line:nth-child(odd) { width: 100%; }
    .sk-line:nth-child(even) { width: 85%; }
    .sk-line.sk-heading { height: 24px; width: 60%; margin: 32px 0 20px; }
    @keyframes skPulse {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* Loading & Error states */
    .reading-loading, .reading-error {
        text-align: center;
        padding: 100px 20px;
        color: #888;
    }
    .reading-loading i, .reading-error i {
        font-size: 48px;
        margin-bottom: 20px;
        display: block;
        color: #e94560;
    }
    .reading-loading i { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .reading-loading h3, .reading-error h3 {
        font-size: 20px;
        color: #333;
        margin-bottom: 10px;
    }
    .reading-error p { margin-bottom: 24px; color: #888; }

    /* ===== TOC SIDEBAR ===== */
    .toc-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.4);
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }
    .toc-overlay.open { opacity: 1; visibility: visible; }
    .toc-sidebar {
        position: fixed;
        top: 0;
        right: 0;
        width: 340px;
        max-width: 85vw;
        height: 100vh;
        background: #fff;
        z-index: 2001;
        transform: translateX(100%);
        transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex;
        flex-direction: column;
        box-shadow: -8px 0 40px rgba(0,0,0,0.1);
    }
    .toc-sidebar.open { transform: translateX(0); }
    .toc-header {
        padding: 20px 24px 16px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
    }
    .toc-header h3 {
        font-size: 15px;
        font-weight: 700;
        color: #333;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .toc-close {
        width: 32px; height: 32px;
        border-radius: 8px;
        border: none;
        background: #f5f5f5;
        color: #888;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .toc-close:hover { background: #eee; color: #e94560; }
    .toc-list {
        flex: 1;
        overflow-y: auto;
        padding: 12px 0;
    }
    .toc-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 24px;
        cursor: pointer;
        transition: all 0.15s;
        border-left: 3px solid transparent;
        font-size: 14px;
        color: #555;
    }
    .toc-item:hover { background: #fafafa; color: #e94560; }
    .toc-item.active {
        background: rgba(233,69,96,0.04);
        color: #e94560;
        font-weight: 600;
        border-left-color: #e94560;
    }
    .toc-item .toc-num {
        font-size: 11px;
        font-weight: 700;
        color: #ccc;
        min-width: 24px;
        text-align: center;
    }
    .toc-item.active .toc-num { color: #e94560; }
    .toc-item .toc-label {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* ===== SETTINGS PANEL ===== */
    .settings-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.4);
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }
    .settings-overlay.open { opacity: 1; visibility: visible; }
    .settings-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        z-index: 2001;
        border-radius: 20px 20px 0 0;
        max-height: 85vh;
        overflow-y: auto;
        transform: translateY(100%);
        transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
        box-shadow: 0 -8px 40px rgba(0,0,0,0.12);
    }
    .settings-panel.open { transform: translateY(0); }
    .settings-handle {
        width: 40px; height: 4px;
        background: #ddd;
        border-radius: 2px;
        margin: 12px auto 0;
    }
    .settings-header {
        padding: 16px 24px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .settings-header h3 {
        font-size: 16px;
        font-weight: 700;
        color: #333;
    }
    .settings-close {
        width: 32px; height: 32px;
        border-radius: 8px;
        border: none;
        background: #f5f5f5;
        color: #888;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .settings-close:hover { background: #eee; color: #e94560; }
    .settings-body { padding: 0 24px 32px; }
    .setting-group {
        margin-bottom: 24px;
    }
    .setting-group label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #999;
        margin-bottom: 10px;
    }
    .setting-row {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .setting-row .size-btn {
        width: 40px; height: 40px;
        border-radius: 10px;
        border: 1.5px solid #e0e0e0;
        background: #fff;
        color: #555;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s;
    }
    .setting-row .size-btn:hover { border-color: #e94560; color: #e94560; }
    .setting-row .size-display {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        min-width: 44px;
        text-align: center;
    }
    .font-options {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    .font-option {
        padding: 8px 16px;
        border: 1.5px solid #e0e0e0;
        border-radius: 10px;
        background: #fff;
        cursor: pointer;
        font-size: 13px;
        color: #555;
        transition: all 0.2s;
    }
    .font-option:hover { border-color: #e94560; color: #e94560; }
    .font-option.active {
        border-color: #e94560;
        background: rgba(233,69,96,0.06);
        color: #e94560;
        font-weight: 600;
    }
    .theme-options {
        display: flex;
        gap: 10px;
    }
    .theme-option {
        flex: 1;
        padding: 14px 10px;
        border: 1.5px solid #e0e0e0;
        border-radius: 12px;
        background: #fff;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
    }
    .theme-option:hover { border-color: #ccc; }
    .theme-option.active { border-color: #e94560; }
    .theme-option .theme-preview {
        width: 36px; height: 36px;
        border-radius: 50%;
        margin: 0 auto 8px;
        border: 2px solid #e0e0e0;
    }
    .theme-option.active .theme-preview { border-color: #e94560; }
    .theme-option .theme-label {
        font-size: 12px;
        font-weight: 600;
        color: #666;
    }
    .theme-option.active .theme-label { color: #e94560; }
    .theme-light .theme-preview { background: #fff; }
    .theme-sepia .theme-preview { background: #f4ecd8; }
    .theme-dark .theme-preview { background: #1a1a2e; }
    .line-height-options {
        display: flex;
        gap: 8px;
    }
    .lh-option {
        flex: 1;
        padding: 10px;
        border: 1.5px solid #e0e0e0;
        border-radius: 10px;
        background: #fff;
        cursor: pointer;
        text-align: center;
        font-size: 12px;
        font-weight: 600;
        color: #666;
        transition: all 0.2s;
    }
    .lh-option:hover { border-color: #e94560; color: #e94560; }
    .lh-option.active {
        border-color: #e94560;
        background: rgba(233,69,96,0.06);
        color: #e94560;
    }
    .width-toggle {
        display: flex;
        gap: 8px;
    }
    .width-option {
        flex: 1;
        padding: 10px;
        border: 1.5px solid #e0e0e0;
        border-radius: 10px;
        background: #fff;
        cursor: pointer;
        text-align: center;
        font-size: 12px;
        font-weight: 600;
        color: #666;
        transition: all 0.2s;
    }
    .width-option:hover { border-color: #e94560; color: #e94560; }
    .width-option.active {
        border-color: #e94560;
        background: rgba(233,69,96,0.06);
        color: #e94560;
    }

    /* Page transition */
    #reading-area.page-transition {
        opacity: 0;
        transform: translateY(12px);
        transition: opacity 0.25s ease, transform 0.25s ease;
    }
    #reading-area.page-visible {
        opacity: 1;
        transform: translateY(0);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    /* Bottom page jump */
    .page-jump-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 12px 0 4px;
    }
    .page-jump-bar label {
        font-size: 13px;
        color: #999;
        font-weight: 500;
    }
    .page-jump-input {
        width: 60px;
        padding: 6px 10px;
        border: 1.5px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        text-align: center;
        color: #333;
        outline: none;
        font-family: inherit;
        transition: border-color 0.2s;
    }
    .page-jump-input:focus { border-color: #e94560; }
    .page-jump-btn {
        padding: 6px 14px;
        border: 1.5px solid #e94560;
        border-radius: 8px;
        background: rgba(233,69,96,0.06);
        color: #e94560;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
    }
    .page-jump-btn:hover { background: #e94560; color: #fff; }

    /* Dark mode pagination */
    body.dark-mode .page-jump-input { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.1); color: #ddd; }
    body.dark-mode .page-jump-btn { background: rgba(233,69,96,0.1); }

    /* Sepia mode pagination */
    body.sepia-mode .page-jump-input { background: #ede0c8; border-color: #c4b393; color: #5b4636; }

    /* Scroll to top */
    .read-scroll-top {
        position: fixed;
        bottom: 28px;
        right: 28px;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: #e94560;
        color: #fff;
        border: none;
        cursor: pointer;
        font-size: 16px;
        box-shadow: 0 4px 20px rgba(233,69,96,0.3);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
        z-index: 999;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .read-scroll-top.visible { opacity: 1; visibility: visible; }
    .read-scroll-top:hover { transform: translateY(-2px); box-shadow: 0 6px 25px rgba(233,69,96,0.4); }

    /* End of book */
    .reader-end {
        text-align: center;
        padding: 60px 20px;
        border-top: 1px solid #f0f0f0;
        margin-top: 48px;
    }
    .reader-end .end-icon {
        font-size: 40px;
        color: #e94560;
        margin-bottom: 16px;
    }
    .reader-end h3 {
        font-size: 20px;
        font-weight: 700;
        color: #333;
        margin-bottom: 8px;
    }
    .reader-end p {
        font-size: 14px;
        color: #999;
        margin-bottom: 24px;
    }
    .reader-end .end-actions {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        flex-wrap: wrap;
    }
    .reader-end .end-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s;
        text-decoration: none;
    }
    .reader-end .end-btn-primary {
        background: #e94560;
        color: #fff;
    }
    .reader-end .end-btn-primary:hover { background: #d63851; }
    .reader-end .end-btn-outline {
        background: transparent;
        color: #e94560;
        border: 1.5px solid #e94560;
    }
    .reader-end .end-btn-outline:hover { background: rgba(233,69,96,0.06); }

    /* ===== DARK MODE ===== */
    body.dark-mode { background: #1a1a2e; }
    body.dark-mode .reader-topbar {
        background: rgba(26,26,46,0.98);
        border-bottom-color: rgba(255,255,255,0.06);
    }
    body.dark-mode .topbar-left .mini-title { color: #ddd; }
    body.dark-mode .topbar-btn { color: #aaa; }
    body.dark-mode .topbar-btn:hover { background: rgba(255,255,255,0.08); color: #e94560; }
    body.dark-mode .reader-breadcrumb { background: rgba(255,255,255,0.02); border-bottom-color: rgba(255,255,255,0.06); }
    body.dark-mode .reader-breadcrumb a { color: #888; }
    body.dark-mode .reader-breadcrumb .bc-current { color: #666; }
    body.dark-mode .reader-title-section .book-title { color: #eee; }
    body.dark-mode .reader-title-section .book-author { color: #888; }
    body.dark-mode .reader-title-section .book-author a { color: #aaa; }
    body.dark-mode .reader-title-section .page-info { color: #777; }
    body.dark-mode .ornament-divider svg { opacity: 0.2; filter: invert(1); }
    body.dark-mode .chapter-nav .nav-btn-prev { background: #555; }
    body.dark-mode .chapter-nav .nav-btn-list { background: #444; }
    body.dark-mode .chapter-nav .nav-btn-next { background: #3d7a3d; }
    body.dark-mode #reading-area { color: #d0d0d0; }
    body.dark-mode #reading-area .section-heading { color: #eee; border-bottom-color: #e94560; }
    body.dark-mode #reading-area .sub-heading { color: #90b4e0; }
    body.dark-mode #reading-area blockquote { background: rgba(255,255,255,0.02); color: #aaa; }
    body.dark-mode .toc-sidebar { background: #1e1e3a; }
    body.dark-mode .toc-header { border-bottom-color: rgba(255,255,255,0.06); }
    body.dark-mode .toc-header h3 { color: #ddd; }
    body.dark-mode .toc-close { background: rgba(255,255,255,0.06); color: #aaa; }
    body.dark-mode .toc-item { color: #aaa; }
    body.dark-mode .toc-item:hover { background: rgba(255,255,255,0.03); color: #e94560; }
    body.dark-mode .toc-item.active { background: rgba(233,69,96,0.08); color: #e94560; }
    body.dark-mode .toc-item .toc-num { color: #555; }
    body.dark-mode .toc-item.active .toc-num { color: #e94560; }
    body.dark-mode .settings-panel { background: #1e1e3a; }
    body.dark-mode .settings-handle { background: rgba(255,255,255,0.15); }
    body.dark-mode .settings-header h3 { color: #ddd; }
    body.dark-mode .settings-close { background: rgba(255,255,255,0.06); color: #aaa; }
    body.dark-mode .setting-group label { color: #777; }
    body.dark-mode .setting-row .size-btn { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.1); color: #ccc; }
    body.dark-mode .setting-row .size-display { color: #ddd; }
    body.dark-mode .font-option { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.1); color: #ccc; }
    body.dark-mode .font-option.active { border-color: #e94560; background: rgba(233,69,96,0.1); color: #e94560; }
    body.dark-mode .theme-option { border-color: rgba(255,255,255,0.1); background: transparent; }
    body.dark-mode .theme-option .theme-label { color: #aaa; }
    body.dark-mode .lh-option { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.1); color: #ccc; }
    body.dark-mode .lh-option.active { border-color: #e94560; background: rgba(233,69,96,0.1); color: #e94560; }
    body.dark-mode .width-option { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.1); color: #ccc; }
    body.dark-mode .width-option.active { border-color: #e94560; background: rgba(233,69,96,0.1); color: #e94560; }
    body.dark-mode .reader-end { border-top-color: rgba(255,255,255,0.06); }
    body.dark-mode .reader-end h3 { color: #eee; }
    body.dark-mode .reader-end p { color: #777; }
    body.dark-mode .reading-error h3 { color: #eee; }
    body.dark-mode .footer { border-top-color: rgba(255,255,255,0.06); }

    /* ===== SEPIA MODE ===== */
    body.sepia-mode { background: #f4ecd8; }
    body.sepia-mode .reader-topbar {
        background: rgba(244,236,216,0.98);
        border-bottom-color: #d4c5a9;
    }
    body.sepia-mode .topbar-left .mini-title { color: #5b4636; }
    body.sepia-mode .topbar-btn { color: #8b7355; }
    body.sepia-mode .reader-breadcrumb { background: rgba(139,115,85,0.04); border-bottom-color: #d4c5a9; }
    body.sepia-mode .reader-breadcrumb a { color: #8b7355; }
    body.sepia-mode .reader-breadcrumb .bc-current { color: #a09070; }
    body.sepia-mode .reader-title-section .book-title { color: #b5451b; }
    body.sepia-mode .reader-title-section .book-author { color: #8b7355; }
    body.sepia-mode .reader-title-section .book-author a { color: #7a6349; }
    body.sepia-mode .reader-title-section .page-info { color: #a09070; }
    body.sepia-mode .ornament-divider svg { opacity: 0.4; }
    body.sepia-mode #reading-area { color: #5b4636; }
    body.sepia-mode #reading-area .section-heading { color: #3e2f1c; }
    body.sepia-mode #reading-area .sub-heading { color: #6b4f2e; }
    body.sepia-mode #reading-area blockquote { background: rgba(139,115,85,0.06); color: #7a6349; }
    body.sepia-mode .toc-sidebar { background: #f4ecd8; }
    body.sepia-mode .toc-header { border-bottom-color: #d4c5a9; }
    body.sepia-mode .toc-header h3 { color: #5b4636; }
    body.sepia-mode .toc-item { color: #7a6349; }
    body.sepia-mode .settings-panel { background: #f4ecd8; }
    body.sepia-mode .settings-header h3 { color: #5b4636; }
    body.sepia-mode .setting-group label { color: #8b7355; }
    body.sepia-mode .reader-end { border-top-color: #d4c5a9; }
    body.sepia-mode .reader-end h3 { color: #3e2f1c; }

    /* Content fade-in */
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(16px); }
        to { opacity: 1; transform: translateY(0); }
    }
    #reading-area.loaded > * {
        animation: fadeInUp 0.5s ease both;
    }
    #reading-area.loaded > *:nth-child(1) { animation-delay: 0s; }
    #reading-area.loaded > *:nth-child(2) { animation-delay: 0.04s; }
    #reading-area.loaded > *:nth-child(3) { animation-delay: 0.08s; }
    #reading-area.loaded > *:nth-child(n+4) { animation-delay: 0.12s; }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
        .reader-topbar { padding: 0 16px; height: 48px; top: 56px; }
        .reader-breadcrumb { padding: 10px 16px; font-size: 12px; }
        .reader-title-section { padding: 24px 16px 10px; }
        .reader-title-section .book-title { font-size: 18px; }
        .chapter-nav { gap: 4px; padding: 8px 12px; }
        .chapter-nav .nav-btn { padding: 10px 16px; font-size: 13px; gap: 6px; }
        .reader-content-wrapper { padding: 32px 18px 60px; }
        #reading-area { font-size: 16px; line-height: 1.8; }
        #reading-area .section-heading { font-size: 1.2em; }
        .toc-sidebar { width: 300px; }
        .settings-panel { border-radius: 16px 16px 0 0; }
        .reader-end { padding: 40px 16px; }
    }
    @media (max-width: 480px) {
        .reader-title-section .book-title { font-size: 16px; letter-spacing: 0.5px; }
        .chapter-nav .nav-btn { padding: 8px 12px; font-size: 12px; }
        .reader-content-wrapper { padding: 24px 16px 50px; }
        #reading-area { font-size: 15px; }
        .page-jump-bar { flex-wrap: wrap; gap: 8px; }
    }
    @media (min-width: 1200px) {
        .reader-content-wrapper { max-width: 740px; }
        .reader-content-wrapper.wide { max-width: 980px; }
    }
    </style>
</head>
<body>

    <!-- PAGE LOADER -->
    <div class="page-loader" id="pageLoader">
        <div class="loader-icon"><i class="fas fa-book-open"></i></div>
        <div class="loader-dots"><span></span><span></span><span></span></div>
        <div class="loader-text">Loading</div>
    </div>

    <!-- HEADER -->
    <header class="header">
        <div class="container">
            <a href="/" class="logo">
                <span class="logo-icon"><i class="fas fa-book-open"></i></span>
                <div>
                    <h1>Book<span>Voyage</span></h1>
                    <p>Reading is a Journey</p>
                </div>
            </a>

            <nav>
                <ul class="nav-menu" id="navMenu">
                    <li><a href="/">Home</a></li>
                    <li>
                        <a href="/catalog/">Library <i class="fas fa-chevron-down" style="font-size:10px;margin-left:4px"></i></a>
                        <ul class="dropdown">
                            <li><a href="/catalog/">All Books</a></li>
                            <li><a href="/catalog/?cat=fiction">Fiction</a></li>
                            <li><a href="/catalog/?cat=nonfiction">Non-Fiction</a></li>
                            <li><a href="/catalog/?cat=science">Science</a></li>
                            <li><a href="/catalog/?cat=children">Children</a></li>
                        </ul>
                    </li>
                    <li><a href="/categories/">Categories</a></li>
                    <li><a href="/java/">Tài liệu Java</a></li>
                    <li><a href="/about/">About</a></li>
                    <li><a href="/contact/">Contact</a></li>
                </ul>
            </nav>

            <div class="nav-auth">
                <a href="/login/" class="btn btn-outline">Login</a>
                <a href="/register/" class="btn btn-primary">Register</a>
            </div>

            <div class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </header>

    <!-- Progress bar -->
    <div class="reading-progress-bar" id="progressBar"></div>

    <!-- Reader top bar -->
    <div class="reader-topbar" id="readerTopbar">
        <div class="topbar-left">
            <div class="mini-title" id="miniTitle">Loading...</div>
        </div>
        <div class="topbar-right">
            <span class="topbar-progress" id="progressText">0%</span>
            <button class="topbar-btn" id="btnToc" title="Mục lục">
                <i class="fas fa-list"></i>
            </button>
            <button class="topbar-btn" id="btnSettings" title="Cài đặt đọc">
                <i class="fas fa-sliders-h"></i>
            </button>
        </div>
    </div>

    <!-- Breadcrumb -->
    <nav class="reader-breadcrumb" id="readerBreadcrumb">
        <a href="/"><i class="fas fa-home"></i> Trang chủ</a>
        <span class="bc-sep">/</span>
        <a href="#" id="bcBookLink">...</a>
        <span class="bc-sep">/</span>
        <span class="bc-current" id="bcPageInfo">Đang tải...</span>
    </nav>

    <!-- Title section -->
    <div class="reader-title-section" id="bookHeader">
        <h1 class="book-title" id="bookTitle">Loading...</h1>
        <p class="book-author" id="bookAuthor"></p>
        <p class="page-info" id="pageInfo"></p>
        <div class="ornament-divider"><svg viewBox="0 0 200 20" xmlns="http://www.w3.org/2000/svg"><path d="M0 10 C30 0, 50 0, 70 10 C80 15, 90 15, 100 10 C110 5, 120 5, 130 10 C150 20, 170 20, 200 10" fill="none" stroke="#b5a27a" stroke-width="1.2"/><path d="M0 10 C30 20, 50 20, 70 10 C80 5, 90 5, 100 10 C110 15, 120 15, 130 10 C150 0, 170 0, 200 10" fill="none" stroke="#b5a27a" stroke-width="1.2"/></svg></div>
    </div>

    <!-- Top chapter navigation -->
    <div class="chapter-nav" id="topChapterNav">
        <button class="nav-btn nav-btn-prev" id="topPrevBtn" disabled><i class="fas fa-chevron-left"></i> Trang trước</button>
        <button class="nav-btn nav-btn-list" id="btnTocAlt" title="Mục lục"><i class="fas fa-list-ul"></i></button>
        <button class="nav-btn nav-btn-next" id="topNextBtn" disabled>Trang tiếp <i class="fas fa-chevron-right"></i></button>
    </div>

    <div class="ornament-divider ornament-large"><svg viewBox="0 0 300 30" xmlns="http://www.w3.org/2000/svg"><path d="M0 15 C20 5, 40 5, 60 15 C70 20, 80 20, 90 15 L100 10 C105 7, 110 5, 120 5 L130 5 C135 5, 137 7, 140 10 L145 15 C147 17, 150 18, 155 15 L160 10 C162 7, 165 5, 170 5 L180 5 C190 5, 195 7, 200 10 L210 15 C220 20, 230 20, 240 15 C260 5, 280 5, 300 15" fill="none" stroke="#b5a27a" stroke-width="1.2"/><path d="M120 3 C130 -2, 140 -2, 150 3 C155 5.5, 145 8, 140 5" fill="none" stroke="#b5a27a" stroke-width="0.8"/><path d="M150 3 C160 -2, 170 -2, 180 3 C175 5.5, 165 8, 160 5" fill="none" stroke="#b5a27a" stroke-width="0.8"/><circle cx="150" cy="2" r="2" fill="#b5a27a" opacity="0.6"/></svg></div>

    <!-- Main reading wrapper -->
    <div class="reader-content-wrapper" id="contentWrapper">
        <div id="reading-area">
            <!-- Skeleton -->
            <div class="skeleton-reading" id="readingSkeleton">
                <div class="sk-line sk-heading"></div>
                <div class="sk-line"></div>
                <div class="sk-line"></div>
                <div class="sk-line"></div>
                <div class="sk-line"></div>
                <div class="sk-line sk-heading"></div>
                <div class="sk-line"></div>
                <div class="sk-line"></div>
                <div class="sk-line"></div>
            </div>
        </div>
    </div>

    <!-- TOC Sidebar -->
    <div class="toc-overlay" id="tocOverlay"></div>
    <div class="toc-sidebar" id="tocSidebar">
        <div class="toc-header">
            <h3><i class="fas fa-list-ol" style="margin-right:8px;"></i> Contents</h3>
            <button class="toc-close" id="tocClose"><i class="fas fa-times"></i></button>
        </div>
        <div class="toc-list" id="tocList"></div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-overlay" id="settingsOverlay"></div>
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-handle"></div>
        <div class="settings-header">
            <h3><i class="fas fa-cog" style="margin-right:8px;"></i> Reading Settings</h3>
            <button class="settings-close" id="settingsClose"><i class="fas fa-times"></i></button>
        </div>
        <div class="settings-body">
            <!-- Font Size -->
            <div class="setting-group">
                <label>Font Size</label>
                <div class="setting-row">
                    <button class="size-btn" id="fontDown"><i class="fas fa-minus"></i></button>
                    <span class="size-display" id="fontSizeDisplay">18px</span>
                    <button class="size-btn" id="fontUp"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <!-- Font Family -->
            <div class="setting-group">
                <label>Font Family</label>
                <div class="font-options" id="fontOptions">
                    <button class="font-option active" data-font="'Merriweather', Georgia, serif" style="font-family: Merriweather, Georgia, serif;">Merriweather</button>
                    <button class="font-option" data-font="'Lora', Georgia, serif" style="font-family: Lora, Georgia, serif;">Lora</button>
                    <button class="font-option" data-font="'Source Serif 4', Georgia, serif" style="font-family: 'Source Serif 4', Georgia, serif;">Source Serif</button>
                    <button class="font-option" data-font="Georgia, serif" style="font-family: Georgia, serif;">Georgia</button>
                    <button class="font-option" data-font="'Segoe UI', system-ui, sans-serif" style="font-family: Segoe UI, system-ui, sans-serif;">Segoe UI</button>
                    <button class="font-option" data-font="system-ui, sans-serif" style="font-family: system-ui, sans-serif;">System</button>
                </div>
            </div>
            <!-- Theme -->
            <div class="setting-group">
                <label>Theme</label>
                <div class="theme-options" id="themeOptions">
                    <div class="theme-option theme-light active" data-theme="light">
                        <div class="theme-preview"></div>
                        <div class="theme-label">Light</div>
                    </div>
                    <div class="theme-option theme-sepia" data-theme="sepia">
                        <div class="theme-preview"></div>
                        <div class="theme-label">Sepia</div>
                    </div>
                    <div class="theme-option theme-dark" data-theme="dark">
                        <div class="theme-preview"></div>
                        <div class="theme-label">Dark</div>
                    </div>
                </div>
            </div>
            <!-- Line Height -->
            <div class="setting-group">
                <label>Line Spacing</label>
                <div class="line-height-options" id="lhOptions">
                    <button class="lh-option" data-lh="1.6">Compact</button>
                    <button class="lh-option" data-lh="1.8">Normal</button>
                    <button class="lh-option active" data-lh="1.9">Relaxed</button>
                    <button class="lh-option" data-lh="2.2">Spacious</button>
                </div>
            </div>
            <!-- Width -->
            <div class="setting-group">
                <label>Reading Width</label>
                <div class="width-toggle" id="widthOptions">
                    <button class="width-option active" data-width="720">Normal</button>
                    <button class="width-option" data-width="960">Wide</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scroll to top -->
    <button class="read-scroll-top" id="scrollTopBtn" title="Scroll to top">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-about">
                    <div class="footer-logo">
                        <span class="logo-icon"><i class="fas fa-book-open"></i></span>
                        <h3>Book<span>Voyage</span></h3>
                    </div>
                    <p>BookVoyage is your gateway to a world of knowledge and imagination. Reading is a journey — start yours today.</p>
                    <div class="footer-social">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                <div class="footer-links">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="/">&#8250; Home</a></li>
                        <li><a href="/catalog/">&#8250; Library</a></li>
                        <li><a href="/categories/">&#8250; Categories</a></li>
                        <li><a href="/about/">&#8250; About Us</a></li>
                        <li><a href="/contact/">&#8250; Contact</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h4>Categories</h4>
                    <ul>
                        <li><a href="/catalog/?cat=fiction">&#8250; Fiction</a></li>
                        <li><a href="/catalog/?cat=science">&#8250; Science</a></li>
                        <li><a href="/catalog/?cat=history">&#8250; History</a></li>
                        <li><a href="/catalog/?cat=technology">&#8250; Technology</a></li>
                        <li><a href="/catalog/?cat=romance">&#8250; Romance</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h4>Support</h4>
                    <ul>
                        <li><a href="#">&#8250; FAQ</a></li>
                        <li><a href="#">&#8250; Help Center</a></li>
                        <li><a href="#">&#8250; Privacy Policy</a></li>
                        <li><a href="#">&#8250; Terms of Service</a></li>
                        <li><a href="/contact/">&#8250; Contact Us</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 BookVoyage. All rights reserved. | Reading is a Journey &#128218;</p>
            </div>
        </div>
    </footer>

    <script src="/js/main.js"></script>
    <script src="/js/books-data.js"></script>
    <script>
    // ============================================
    // PROFESSIONAL READER ENGINE — PAGINATED
    // Page-by-page reading, TOC sidebar, Settings panel
    // Keyboard shortcuts, Reading position memory
    // ============================================

    (function() {
        'use strict';

        // === CONSTANTS ===
        var PARAGRAPHS_PER_PAGE = 12; // paragraphs per page

        // === READING PREFERENCES (persisted) ===
        var prefs = {
            fontSize: parseInt(localStorage.getItem('bv_fontSize')) || 18,
            lineHeight: parseFloat(localStorage.getItem('bv_lineHeight')) || 1.9,
            font: localStorage.getItem('bv_font') || "'Merriweather', Georgia, serif",
            theme: localStorage.getItem('bv_theme') || 'sepia',
            width: parseInt(localStorage.getItem('bv_width')) || 720
        };

        // Apply theme immediately to avoid flash
        if (prefs.theme === 'dark') document.body.classList.add('dark-mode');
        if (prefs.theme === 'sepia') document.body.classList.add('sepia-mode');

        // === ELEMENTS ===
        var els = {};
        var sectionHeadings = []; // [{id, title, el, pageIndex}]
        var bookInfo = null;

        // === PAGINATION STATE ===
        var allParsedElements = []; // array of HTML strings for each content element
        var currentPage = 1;
        var totalPages = 1;
        var paginationContainer = null;

        document.addEventListener('DOMContentLoaded', function() {
            els = {
                progressBar: document.getElementById('progressBar'),
                topbar: document.getElementById('readerTopbar'),
                miniTitle: document.getElementById('miniTitle'),
                progressText: document.getElementById('progressText'),
                btnToc: document.getElementById('btnToc'),
                btnSettings: document.getElementById('btnSettings'),
                bookHeader: document.getElementById('bookHeader'),
                bookTitle: document.getElementById('bookTitle'),
                bookAuthor: document.getElementById('bookAuthor'),
                pageInfo: document.getElementById('pageInfo'),
                bcBookLink: document.getElementById('bcBookLink'),
                bcPageInfo: document.getElementById('bcPageInfo'),
                contentWrapper: document.getElementById('contentWrapper'),
                readingArea: document.getElementById('reading-area'),
                skeleton: document.getElementById('readingSkeleton'),
                tocOverlay: document.getElementById('tocOverlay'),
                tocSidebar: document.getElementById('tocSidebar'),
                tocClose: document.getElementById('tocClose'),
                tocList: document.getElementById('tocList'),
                settingsOverlay: document.getElementById('settingsOverlay'),
                settingsPanel: document.getElementById('settingsPanel'),
                settingsClose: document.getElementById('settingsClose'),
                fontDown: document.getElementById('fontDown'),
                fontUp: document.getElementById('fontUp'),
                fontSizeDisplay: document.getElementById('fontSizeDisplay'),
                fontOptions: document.getElementById('fontOptions'),
                themeOptions: document.getElementById('themeOptions'),
                lhOptions: document.getElementById('lhOptions'),
                widthOptions: document.getElementById('widthOptions'),
                scrollTopBtn: document.getElementById('scrollTopBtn')
            };

            applyPreferences();
            loadBookContent();
            setupEventListeners();
            setupScrollTracking();
            setupKeyboardShortcuts();
        });

        // === APPLY PREFERENCES ===
        function applyPreferences() {
            var area = els.readingArea;
            area.style.fontSize = prefs.fontSize + 'px';
            area.style.lineHeight = prefs.lineHeight;
            area.style.fontFamily = prefs.font;
            els.fontSizeDisplay.textContent = prefs.fontSize + 'px';

            if (prefs.width > 720) {
                els.contentWrapper.classList.add('wide');
            }

            // Sync settings UI
            syncSettingsUI();
        }

        function syncSettingsUI() {
            // Font options
            els.fontOptions.querySelectorAll('.font-option').forEach(function(btn) {
                btn.classList.toggle('active', btn.dataset.font === prefs.font);
            });
            // Theme options
            els.themeOptions.querySelectorAll('.theme-option').forEach(function(opt) {
                opt.classList.toggle('active', opt.dataset.theme === prefs.theme);
            });
            // Line height
            els.lhOptions.querySelectorAll('.lh-option').forEach(function(opt) {
                opt.classList.toggle('active', parseFloat(opt.dataset.lh) === prefs.lineHeight);
            });
            // Width
            els.widthOptions.querySelectorAll('.width-option').forEach(function(opt) {
                opt.classList.toggle('active', parseInt(opt.dataset.width) === prefs.width);
            });
        }

        function savePref(key, value) {
            prefs[key] = value;
            localStorage.setItem('bv_' + key, value);
        }

        // === EVENT LISTENERS ===
        function setupEventListeners() {
            // TOC toggle
            els.btnToc.addEventListener('click', function() { toggleToc(true); });
            els.tocOverlay.addEventListener('click', function() { toggleToc(false); });
            els.tocClose.addEventListener('click', function() { toggleToc(false); });

            // Settings toggle
            els.btnSettings.addEventListener('click', function() { toggleSettings(true); });
            els.settingsOverlay.addEventListener('click', function() { toggleSettings(false); });
            els.settingsClose.addEventListener('click', function() { toggleSettings(false); });

            // Font size
            els.fontDown.addEventListener('click', function() {
                var newSize = Math.max(12, prefs.fontSize - 2);
                savePref('fontSize', newSize);
                els.readingArea.style.fontSize = newSize + 'px';
                els.fontSizeDisplay.textContent = newSize + 'px';
            });
            els.fontUp.addEventListener('click', function() {
                var newSize = Math.min(32, prefs.fontSize + 2);
                savePref('fontSize', newSize);
                els.readingArea.style.fontSize = newSize + 'px';
                els.fontSizeDisplay.textContent = newSize + 'px';
            });

            // Font family
            els.fontOptions.addEventListener('click', function(e) {
                var btn = e.target.closest('.font-option');
                if (!btn) return;
                savePref('font', btn.dataset.font);
                els.readingArea.style.fontFamily = btn.dataset.font;
                els.fontOptions.querySelectorAll('.font-option').forEach(function(b) {
                    b.classList.toggle('active', b === btn);
                });
            });

            // Theme
            els.themeOptions.addEventListener('click', function(e) {
                var opt = e.target.closest('.theme-option');
                if (!opt) return;
                var theme = opt.dataset.theme;
                document.body.classList.remove('dark-mode', 'sepia-mode');
                if (theme === 'dark') document.body.classList.add('dark-mode');
                if (theme === 'sepia') document.body.classList.add('sepia-mode');
                savePref('theme', theme);
                els.themeOptions.querySelectorAll('.theme-option').forEach(function(o) {
                    o.classList.toggle('active', o === opt);
                });
            });

            // Line height
            els.lhOptions.addEventListener('click', function(e) {
                var opt = e.target.closest('.lh-option');
                if (!opt) return;
                var lh = parseFloat(opt.dataset.lh);
                savePref('lineHeight', lh);
                els.readingArea.style.lineHeight = lh;
                els.lhOptions.querySelectorAll('.lh-option').forEach(function(o) {
                    o.classList.toggle('active', o === opt);
                });
            });

            // Width
            els.widthOptions.addEventListener('click', function(e) {
                var opt = e.target.closest('.width-option');
                if (!opt) return;
                var w = parseInt(opt.dataset.width);
                savePref('width', w);
                els.contentWrapper.classList.toggle('wide', w > 720);
                els.widthOptions.querySelectorAll('.width-option').forEach(function(o) {
                    o.classList.toggle('active', o === opt);
                });
            });

            // Scroll to top
            els.scrollTopBtn.addEventListener('click', function() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // Top chapter nav buttons
            var topPrev = document.getElementById('topPrevBtn');
            var topNext = document.getElementById('topNextBtn');
            var btnTocAlt = document.getElementById('btnTocAlt');
            if (topPrev) topPrev.addEventListener('click', function() { goToPage(currentPage - 1); });
            if (topNext) topNext.addEventListener('click', function() { goToPage(currentPage + 1); });
            if (btnTocAlt) btnTocAlt.addEventListener('click', function() { toggleToc(true); });
        }

        // === TOC / SETTINGS TOGGLES ===
        function toggleToc(open) {
            els.tocOverlay.classList.toggle('open', open);
            els.tocSidebar.classList.toggle('open', open);
            els.btnToc.classList.toggle('active', open);
            document.body.style.overflow = open ? 'hidden' : '';
        }

        function toggleSettings(open) {
            els.settingsOverlay.classList.toggle('open', open);
            els.settingsPanel.classList.toggle('open', open);
            els.btnSettings.classList.toggle('active', open);
            document.body.style.overflow = open ? 'hidden' : '';
        }

        // === SCROLL TRACKING (simplified for paginated) ===
        function setupScrollTracking() {
            var ticking = false;
            window.addEventListener('scroll', function() {
                if (ticking) return;
                ticking = true;
                requestAnimationFrame(function() {
                    var scrollTop = window.scrollY || document.documentElement.scrollTop;

                    // Mini title visibility
                    var headerBottom = els.bookHeader.offsetTop + els.bookHeader.offsetHeight;
                    els.miniTitle.classList.toggle('visible', scrollTop > headerBottom - 60);

                    // Topbar shadow
                    els.topbar.classList.toggle('shadow', scrollTop > 10);

                    // Scroll to top button
                    els.scrollTopBtn.classList.toggle('visible', scrollTop > 600);

                    ticking = false;
                });
            }, { passive: true });
        }

        function saveReadingPage() {
            var bookId = new URLSearchParams(window.location.search).get('id');
            if (bookId) {
                localStorage.setItem('bv_page_' + bookId, currentPage);
            }
        }

        function restoreReadingPage() {
            var bookId = new URLSearchParams(window.location.search).get('id');
            if (!bookId) return;
            var saved = parseInt(localStorage.getItem('bv_page_' + bookId));
            if (saved && saved > 1 && saved <= totalPages) {
                goToPage(saved, false);
            }
        }

        // === KEYBOARD SHORTCUTS ===
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Escape closes panels
                if (e.key === 'Escape') {
                    toggleToc(false);
                    toggleSettings(false);
                }
                // 't' opens TOC
                if (e.key === 't' && !isTyping(e)) {
                    e.preventDefault();
                    toggleToc(!els.tocSidebar.classList.contains('open'));
                }
                // 's' opens settings
                if (e.key === 's' && !isTyping(e)) {
                    e.preventDefault();
                    toggleSettings(!els.settingsPanel.classList.contains('open'));
                }
                // Arrow left / right for page navigation
                if (e.key === 'ArrowLeft' && !isTyping(e)) {
                    e.preventDefault();
                    goToPage(currentPage - 1);
                }
                if (e.key === 'ArrowRight' && !isTyping(e)) {
                    e.preventDefault();
                    goToPage(currentPage + 1);
                }
            });
        }

        function isTyping(e) {
            var tag = (e.target.tagName || '').toLowerCase();
            return tag === 'input' || tag === 'textarea' || tag === 'select' || e.target.isContentEditable;
        }

        // === CONTENT PARSING (returns array of HTML element strings) ===
        function parseContent(text) {
            var elements = [];
            var paragraphs = text.split(/\n\s*\n/);
            var sectionIndex = 0;
            var sectionHeaderPattern = /^[A-Z\s\d═━─╌:&,.'\-!?()]{5,}$/;
            var separatorPattern = /^[═━─╌\-_~*]{5,}$/;

            paragraphs.forEach(function(para) {
                var trimmed = para.trim();
                if (!trimmed) return;

                // Separator lines
                if (separatorPattern.test(trimmed)) {
                    elements.push({ html: '<div class="separator">• • •</div>', type: 'separator' });
                    return;
                }

                // Section headers (ALL CAPS)
                if (sectionHeaderPattern.test(trimmed) && trimmed.length < 80 && trimmed.length > 3) {
                    sectionIndex++;
                    var sectionId = 'section-' + sectionIndex;
                    var title = formatHeading(trimmed);
                    elements.push({ html: '<h2 class="section-heading" id="' + sectionId + '">' + escapeHtml(title) + '</h2>', type: 'heading', sectionId: sectionId, title: title });
                    sectionHeadings.push({ id: sectionId, title: title, elementIndex: elements.length - 1 });
                    return;
                }

                // Chapter/Part sub-headings
                if (/^(Chapter|Part|CHAPTER|PART)\s/i.test(trimmed) && trimmed.length < 120) {
                    elements.push({ html: '<h3 class="sub-heading">' + escapeHtml(trimmed).replace(/\n/g, '<br>') + '</h3>', type: 'subheading' });
                    return;
                }

                // Quotes
                if (trimmed.startsWith('"') && trimmed.endsWith('"') && trimmed.length < 300) {
                    elements.push({ html: '<blockquote>' + escapeHtml(trimmed) + '</blockquote>', type: 'quote' });
                    return;
                }

                // List items
                if (/^(\d+\.\s|[-•]\s)/.test(trimmed)) {
                    elements.push({ html: '<p class="list-item">' + escapeHtml(trimmed).replace(/\n/g, '<br>') + '</p>', type: 'list' });
                    return;
                }

                // Regular paragraph
                elements.push({ html: '<p>' + escapeHtml(trimmed).replace(/\n/g, '<br>') + '</p>', type: 'paragraph' });
            });

            return elements;
        }

        function formatHeading(text) {
            return text.replace(/[═━─╌]/g, '').trim().split(/\s+/).map(function(word) {
                if (word.length <= 2) return word.toLowerCase();
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }).join(' ');
        }

        function escapeHtml(str) {
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        function estimateReadingTime(text) {
            var words = text.split(/\s+/).length;
            var minutes = Math.ceil(words / 230);
            return { words: words, minutes: minutes };
        }

        // === PAGINATION ENGINE ===
        function getPageElements(page) {
            var start = (page - 1) * PARAGRAPHS_PER_PAGE;
            var end = Math.min(start + PARAGRAPHS_PER_PAGE, allParsedElements.length);
            return allParsedElements.slice(start, end);
        }

        function renderPage(page, animate) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;

            var pageElements = getPageElements(page);
            var html = pageElements.map(function(el) { return el.html; }).join('\n');

            if (animate !== false) {
                els.readingArea.classList.remove('page-visible');
                els.readingArea.classList.add('page-transition');

                setTimeout(function() {
                    els.readingArea.innerHTML = html;
                    els.readingArea.classList.remove('page-transition');
                    els.readingArea.classList.add('page-visible');
                }, 250);
            } else {
                els.readingArea.innerHTML = html;
                els.readingArea.classList.add('page-visible');
            }

            // Update progress
            var progress = Math.round((page / totalPages) * 100);
            els.progressBar.style.width = progress + '%';
            els.progressText.textContent = 'Trang ' + page + '/' + totalPages;

            // Update pagination buttons
            updatePaginationUI();

            // Update active TOC item
            updateActiveTocForPage(page);

            // Save position
            saveReadingPage();

            // Show/hide end section
            var endSection = els.contentWrapper.querySelector('.reader-end');
            if (endSection) {
                endSection.style.display = (page === totalPages) ? 'block' : 'none';
            }
        }

        function goToPage(page, animate) {
            if (page < 1 || page > totalPages) return;
            renderPage(page, animate);
            // Scroll to top of content
            var topY = els.contentWrapper.offsetTop - 60;
            window.scrollTo({ top: topY, behavior: 'smooth' });
        }

        function updatePaginationUI() {
            // Update top nav
            var topPrev = document.getElementById('topPrevBtn');
            var topNext = document.getElementById('topNextBtn');
            if (topPrev) topPrev.disabled = (currentPage <= 1);
            if (topNext) topNext.disabled = (currentPage >= totalPages);

            // Update bottom nav
            var bottomPrev = document.getElementById('bottomPrevBtn');
            var bottomNext = document.getElementById('bottomNextBtn');
            if (bottomPrev) bottomPrev.disabled = (currentPage <= 1);
            if (bottomNext) bottomNext.disabled = (currentPage >= totalPages);

            // Update page info
            if (els.pageInfo) {
                els.pageInfo.textContent = 'Trang ' + currentPage + ' / ' + totalPages;
            }

            // Update breadcrumb page info
            if (els.bcPageInfo) {
                els.bcPageInfo.textContent = 'Trang ' + currentPage + '/' + totalPages;
            }

            // Update jump input
            var jumpInput = paginationContainer ? paginationContainer.querySelector('.page-jump-input') : null;
            if (jumpInput) jumpInput.value = currentPage;
        }

        function updateActiveTocForPage(page) {
            if (sectionHeadings.length === 0) return;
            var startIdx = (page - 1) * PARAGRAPHS_PER_PAGE;
            var endIdx = startIdx + PARAGRAPHS_PER_PAGE;
            var activeId = null;

            // Find the last section heading that appears on or before this page
            for (var i = sectionHeadings.length - 1; i >= 0; i--) {
                if (sectionHeadings[i].elementIndex < endIdx) {
                    activeId = sectionHeadings[i].id;
                    break;
                }
            }

            if (activeId) {
                els.tocList.querySelectorAll('.toc-item').forEach(function(item) {
                    item.classList.toggle('active', item.dataset.id === activeId);
                });
            }
        }

        function createPagination() {
            paginationContainer = document.createElement('div');
            paginationContainer.innerHTML =
                '<div class="ornament-divider ornament-large"><svg viewBox="0 0 300 30" xmlns="http://www.w3.org/2000/svg"><path d="M0 15 C20 5, 40 5, 60 15 C70 20, 80 20, 90 15 L100 10 C105 7, 110 5, 120 5 L130 5 C135 5, 137 7, 140 10 L145 15 C147 17, 150 18, 155 15 L160 10 C162 7, 165 5, 170 5 L180 5 C190 5, 195 7, 200 10 L210 15 C220 20, 230 20, 240 15 C260 5, 280 5, 300 15" fill="none" stroke="#b5a27a" stroke-width="1.2"/><path d="M120 3 C130 -2, 140 -2, 150 3 C155 5.5, 145 8, 140 5" fill="none" stroke="#b5a27a" stroke-width="0.8"/><path d="M150 3 C160 -2, 170 -2, 180 3 C175 5.5, 165 8, 160 5" fill="none" stroke="#b5a27a" stroke-width="0.8"/><circle cx="150" cy="2" r="2" fill="#b5a27a" opacity="0.6"/></svg></div>' +
                '<div class="chapter-nav">' +
                    '<button class="nav-btn nav-btn-prev" id="bottomPrevBtn" title="Trang trước (←)"><i class="fas fa-chevron-left"></i> Trang trước</button>' +
                    '<button class="nav-btn nav-btn-list" id="btnTocBottom" title="Mục lục"><i class="fas fa-list-ul"></i></button>' +
                    '<button class="nav-btn nav-btn-next" id="bottomNextBtn" title="Trang tiếp (→)">Trang tiếp <i class="fas fa-chevron-right"></i></button>' +
                '</div>' +
                '<div class="page-jump-bar">' +
                    '<label>Đến trang:</label>' +
                    '<input type="number" class="page-jump-input" min="1" max="' + totalPages + '" value="1">' +
                    '<button class="page-jump-btn">Đi</button>' +
                '</div>';

            // Insert after reading-area, before end section
            els.contentWrapper.insertBefore(paginationContainer, els.contentWrapper.querySelector('.reader-end'));

            // Bottom nav event listeners
            document.getElementById('bottomPrevBtn').addEventListener('click', function() {
                goToPage(currentPage - 1);
            });
            document.getElementById('bottomNextBtn').addEventListener('click', function() {
                goToPage(currentPage + 1);
            });
            document.getElementById('btnTocBottom').addEventListener('click', function() {
                toggleToc(true);
            });
            paginationContainer.querySelector('.page-jump-btn').addEventListener('click', function() {
                var input = paginationContainer.querySelector('.page-jump-input');
                var page = parseInt(input.value);
                if (page >= 1 && page <= totalPages) {
                    goToPage(page);
                }
            });
            paginationContainer.querySelector('.page-jump-input').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    var page = parseInt(this.value);
                    if (page >= 1 && page <= totalPages) {
                        goToPage(page);
                    }
                }
            });

            // Swipe support for mobile
            setupSwipeNavigation();
        }

        function setupSwipeNavigation() {
            var startX = 0;
            var startY = 0;
            var threshold = 60;

            els.readingArea.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            }, { passive: true });

            els.readingArea.addEventListener('touchend', function(e) {
                var diffX = e.changedTouches[0].clientX - startX;
                var diffY = e.changedTouches[0].clientY - startY;

                // Only detect horizontal swipes (not vertical scrolling)
                if (Math.abs(diffX) > threshold && Math.abs(diffX) > Math.abs(diffY) * 1.5) {
                    if (diffX < 0) {
                        // Swipe left → next page
                        goToPage(currentPage + 1);
                    } else {
                        // Swipe right → previous page
                        goToPage(currentPage - 1);
                    }
                }
            }, { passive: true });
        }

        // === BUILD TOC ===
        function buildToc() {
            if (sectionHeadings.length === 0) {
                els.btnToc.style.display = 'none';
                return;
            }
            var html = '';
            sectionHeadings.forEach(function(section, i) {
                var pageForSection = Math.floor(section.elementIndex / PARAGRAPHS_PER_PAGE) + 1;
                html += '<div class="toc-item' + (i === 0 ? ' active' : '') + '" data-id="' + section.id + '" data-page="' + pageForSection + '">';
                html += '<span class="toc-num">' + (i + 1) + '</span>';
                html += '<span class="toc-label">' + section.title + '</span>';
                html += '</div>';
            });
            els.tocList.innerHTML = html;

            // Click handler — navigates to the page containing the section
            els.tocList.addEventListener('click', function(e) {
                var item = e.target.closest('.toc-item');
                if (!item) return;
                var page = parseInt(item.dataset.page);
                if (page) {
                    toggleToc(false);
                    setTimeout(function() {
                        goToPage(page);
                    }, 100);
                }
            });
        }

        // === END OF BOOK ===
        function appendEndSection() {
            var endDiv = document.createElement('div');
            endDiv.className = 'reader-end';
            endDiv.style.display = 'none'; // hidden until last page
            endDiv.innerHTML =
                '<div class="end-icon"><i class="fas fa-bookmark"></i></div>' +
                '<h3>Hết sách</h3>' +
                '<p>Bạn đã đọc xong ' + (bookInfo ? '"' + bookInfo.title + '"' : 'cuốn sách này') + '. Chúc bạn đọc vui!</p>' +
                '<div class="end-actions">' +
                '<a href="/" class="end-btn end-btn-primary"><i class="fas fa-home"></i> Trang chủ</a>' +
                '<a href="/catalog/" class="end-btn end-btn-outline"><i class="fas fa-book"></i> Thư viện</a>' +
                '</div>';
            els.contentWrapper.appendChild(endDiv);
        }

        // === LOAD BOOK CONTENT ===
        function loadBookContent() {
            var urlParams = new URLSearchParams(window.location.search);
            var bookId = parseInt(urlParams.get('id'));

            if (!bookId) {
                if (els.skeleton) els.skeleton.remove();
                showError('Chưa chọn sách', 'Vui lòng quay lại thư viện và chọn sách để đọc.');
                return;
            }

            // Try to get book info from BOOKS_DATA
            bookInfo = (typeof BOOKS_DATA !== 'undefined') ? BOOKS_DATA.find(function(b) { return b.id === bookId; }) : null;

            if (bookInfo) {
                els.bookTitle.textContent = bookInfo.title;
                els.miniTitle.textContent = bookInfo.title;
                document.title = bookInfo.title + ' — Read | BookVoyage';
                els.bookAuthor.innerHTML = 'bởi <a href="/catalog/?q=' + encodeURIComponent(bookInfo.author) + '">' + bookInfo.author + '</a>';
                // Breadcrumb
                if (els.bcBookLink) {
                    els.bcBookLink.textContent = bookInfo.title;
                    els.bcBookLink.href = '/book-detail/?id=' + bookId;
                }
            }

            // Fetch content
            fetch('/data/books.json')
                .then(function(res) {
                    if (!res.ok) throw new Error('Cannot load books.json');
                    return res.json();
                })
                .then(function(readingBooks) {
                    var readingBook = readingBooks.find(function(rb) { return rb.id === bookId; });
                    if (!readingBook) {
                        if (els.skeleton) els.skeleton.remove();
                        showError('Không có nội dung', 'Nội dung đọc cho cuốn sách này không tìm thấy.');
                        return;
                    }
                    if (!bookInfo) {
                        els.bookTitle.textContent = readingBook.title;
                        els.miniTitle.textContent = readingBook.title;
                        document.title = readingBook.title + ' — Read | BookVoyage';
                    }
                    return fetch(readingBook.content_file);
                })
                .then(function(res) {
                    if (!res) return;
                    if (!res.ok) throw new Error('Content file not found');
                    return res.text();
                })
                .then(function(text) {
                    if (!text) return;

                    // Parse content into elements
                    allParsedElements = parseContent(text);
                    totalPages = Math.ceil(allParsedElements.length / PARAGRAPHS_PER_PAGE);

                    // Append end section (hidden by default)
                    appendEndSection();

                    // Create pagination controls
                    createPagination();

                    // Build TOC
                    buildToc();

                    // Render first page (or restore position)
                    renderPage(1, false);
                    restoreReadingPage();
                })
                .catch(function(err) {
                    console.error('Error loading book:', err);
                    if (els.skeleton) els.skeleton.remove();
                    showError('Lỗi tải nội dung', 'Đã xảy ra lỗi khi tải sách. Vui lòng thử lại.');
                });
        }

        function showError(title, message) {
            els.readingArea.innerHTML =
                '<div class="reading-error">' +
                '<i class="fas fa-book"></i>' +
                '<h3>' + title + '</h3>' +
                '<p>' + message + '</p>' +
                '<a href="/" class="end-btn end-btn-primary" style="display:inline-flex;"><i class="fas fa-home"></i> Trang chủ</a>' +
                '</div>';
        }

    })();

    // Page loader — hide once content is ready  
    (function() {
        var loader = document.getElementById('pageLoader');
        if (!loader) return;
        function hideLoader() {
            loader.classList.add('hidden');
            setTimeout(function() { if (loader.parentNode) loader.parentNode.removeChild(loader); }, 500);
        }
        window.addEventListener('load', function() { setTimeout(hideLoader, 350); });
        setTimeout(hideLoader, 4000);
    })();
    </script>
</body>
</html>